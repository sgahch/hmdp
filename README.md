# é»‘é©¬ç‚¹è¯„ (HMDP) - æœ¬åœ°ç”Ÿæ´»æœåŠ¡å¹³å°

> åŸºäºSpring Boot + Redis + RabbitMQçš„é«˜æ€§èƒ½æœ¬åœ°ç”Ÿæ´»æœåŠ¡å¹³å°ï¼Œç±»ä¼¼å¤§ä¼—ç‚¹è¯„çš„åŠŸèƒ½å®ç°

![GitHub è´¡çŒ®è´ªåƒè›‡](https://raw.githubusercontent.com/yuaotian/yuaotian/refs/heads/output/github-contribution-grid-snake.svg)

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

é»‘é©¬ç‚¹è¯„æ˜¯ä¸€ä¸ªå®Œæ•´çš„æœ¬åœ°ç”Ÿæ´»æœåŠ¡å¹³å°ï¼Œæä¾›å•†é“ºæŸ¥è¯¢ã€ä¼˜æƒ åˆ¸ç§’æ€ã€ç”¨æˆ·ç¤¾äº¤ã€åšå®¢åˆ†äº«ç­‰åŠŸèƒ½ã€‚é¡¹ç›®é‡ç‚¹å±•ç¤ºäº†Redisç¼“å­˜ã€RabbitMQæ¶ˆæ¯é˜Ÿåˆ—ã€åˆ†å¸ƒå¼é”ç­‰æŠ€æœ¯åœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸­çš„åº”ç”¨ï¼Œå¹¶é’ˆå¯¹é«˜å¹¶å‘åœºæ™¯è¿›è¡Œäº†æ·±åº¦ä¼˜åŒ–ã€‚

## ğŸ†• æœ€æ–°æ›´æ–°

- âœ… **ç”¨æˆ·ä½“éªŒå¤§å¹…æå‡**:
  - æ–°å¢ä¸“é—¨çš„å¤´åƒä¸Šä¼ æ¥å£ï¼Œæ”¯æŒæ–‡ä»¶é€‰æ‹©å’Œè‡ªåŠ¨æ›´æ–°
  - ä¿®å¤ç”¨æˆ·ä¿¡æ¯æ›´æ–°åå‰ç«¯ä¸æ˜¾ç¤ºçš„é—®é¢˜
  - å®Œå–„Redisç¼“å­˜åŒæ­¥æœºåˆ¶ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- âœ… **ç™»å½•ç³»ç»Ÿä¼˜åŒ–**:
  - ä¿®å¤ç™»å½•æ—¶çš„NullPointerExceptioné—®é¢˜
  - ä¿®å¤ç™»å‡ºæ—¶Redis Keyé”™è¯¯åˆ é™¤çš„é—®é¢˜
  - å®Œå–„Tokenç®¡ç†å’Œä¼šè¯å¤„ç†
- âœ… **æ¶ˆæ¯é˜Ÿåˆ—å‡çº§**: ä»Redis Streamè¿ç§»åˆ°RabbitMQï¼Œæå‡æ¶ˆæ¯å¤„ç†çš„å¯é æ€§å’Œç›‘æ§èƒ½åŠ›
- âœ… **é”™è¯¯å¤„ç†ä¼˜åŒ–**: å®Œå–„äº†Luaè„šæœ¬çš„nilå€¼æ£€æŸ¥å’ŒRabbitMQçš„é€šé“é”™è¯¯å¤„ç†
- âœ… **æ•°æ®ç®¡ç†å¢å¼º**: æ–°å¢ç§’æ€æ•°æ®åˆå§‹åŒ–å’Œæ¸…ç†åŠŸèƒ½
- âœ… **ç›‘æ§æ—¥å¿—å®Œå–„**: æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥

### ğŸ› ï¸ æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|--|----|
| **åç«¯æ¡†æ¶** |  |    |
| Spring Boot | 2.7.4 | ä¸»æ¡†æ¶ |
| MyBatis Plus | 3.5.2 | ORMæ¡†æ¶ |
| Spring AMQP | 2.7.4 | RabbitMQé›†æˆ |
| **æ•°æ®å­˜å‚¨** |  |    |
| MySQL | 8.0+ | å…³ç³»å‹æ•°æ®åº“ |
| Redis | 6.0+ | ç¼“å­˜æ•°æ®åº“ |
| **æ¶ˆæ¯é˜Ÿåˆ—** |  |    |
| RabbitMQ | 3.8+ | æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ |
| **å·¥å…·åº“** |  |    |
| Hutool | 5.8.8 | Javaå·¥å…·åº“ |
| Redisson | 3.17.7 | Redisåˆ†å¸ƒå¼é” |
| Lombok | 1.18.30 | ä»£ç ç®€åŒ– |

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

#### 1. ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ âœ¨
- **æ‰‹æœºéªŒè¯ç ç™»å½•**: åŸºäºRedisçš„éªŒè¯ç å­˜å‚¨å’Œæ ¡éªŒï¼Œæ”¯æŒTokenè‡ªåŠ¨ç»­æœŸ
- **ç”¨æˆ·ä¿¡æ¯ç®¡ç†**:
  - ç”¨æˆ·èµ„æ–™ç¼–è¾‘ï¼ˆæ˜µç§°ã€ä¸ªäººä»‹ç»ã€æ€§åˆ«ã€åŸå¸‚ã€ç”Ÿæ—¥ï¼‰
  - **å¤´åƒä¸Šä¼ **: ä¸“é—¨çš„å¤´åƒä¸Šä¼ æ¥å£ï¼Œè‡ªåŠ¨æ›´æ–°æ•°æ®åº“å’ŒRedisç¼“å­˜
  - **å®æ—¶åŒæ­¥**: ä¿¡æ¯æ›´æ–°åå‰ç«¯ç«‹å³æ˜¾ç¤ºï¼Œæ•°æ®åº“ä¸ç¼“å­˜ä¿æŒä¸€è‡´
- **ä¼šè¯ç®¡ç†**: å®Œå–„çš„ç™»å½•/ç™»å‡ºæœºåˆ¶ï¼Œæ­£ç¡®çš„Redis Keyç®¡ç†
- **ç­¾åˆ°ç³»ç»Ÿ**: åŸºäºRedis BitMapçš„è¿ç»­ç­¾åˆ°ç»Ÿè®¡

#### 2. å•†é“ºç®¡ç†ç³»ç»Ÿ
- **å•†é“ºä¿¡æ¯æŸ¥è¯¢**: æ”¯æŒåˆ†ç±»ã€åœ°ç†ä½ç½®æŸ¥è¯¢
- **ç¼“å­˜ç­–ç•¥**:
  - ç¼“å­˜ç©¿é€è§£å†³æ–¹æ¡ˆï¼ˆç©ºå€¼ç¼“å­˜ï¼‰
  - ç¼“å­˜é›ªå´©è§£å†³æ–¹æ¡ˆï¼ˆTTLéšæœºåŒ–ï¼‰
  - ç¼“å­˜å‡»ç©¿è§£å†³æ–¹æ¡ˆï¼ˆäº’æ–¥é”ã€é€»è¾‘è¿‡æœŸï¼‰

#### 3. ä¼˜æƒ åˆ¸ç§’æ€ç³»ç»Ÿ ğŸ”¥
- **ç§’æ€åŠŸèƒ½**: é«˜å¹¶å‘ç§’æ€ä¼˜æƒ åˆ¸ï¼Œæ”¯æŒåº“å­˜é¢„æ‰£å‡
- **åˆ†å¸ƒå¼é”**: åŸºäºRedis + Redissonçš„åˆ†å¸ƒå¼é”é˜²æ­¢è¶…å–
- **å¼‚æ­¥å¤„ç†**: Luaè„šæœ¬ + RabbitMQæ¶ˆæ¯é˜Ÿåˆ—ä¼˜åŒ–æ€§èƒ½
- **ä¸€äººä¸€å•**: é˜²æ­¢ç”¨æˆ·é‡å¤ä¸‹å•ï¼Œæ”¯æŒå¹‚ç­‰æ€§å¤„ç†
- **æ¶ˆæ¯å¯é æ€§**: RabbitMQæ­»ä¿¡é˜Ÿåˆ— + é‡è¯•æœºåˆ¶ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±
- **æ•°æ®ç®¡ç†**: è‡ªåŠ¨åˆå§‹åŒ–ç§’æ€åº“å­˜ï¼Œæ¸…ç†è¿‡æœŸæ•°æ®

#### 4. åšå®¢ç¤¾äº¤ç³»ç»Ÿ
- **åšå®¢å‘å¸ƒ**: ç”¨æˆ·å¯å‘å¸ƒå›¾æ–‡åšå®¢
- **ç‚¹èµåŠŸèƒ½**: åŸºäºRedis ZSetçš„ç‚¹èµæ’è¡Œæ¦œ
- **å…³æ³¨ç³»ç»Ÿ**: ç”¨æˆ·å…³æ³¨/å–å…³ï¼Œå…±åŒå…³æ³¨æŸ¥è¯¢
- **Feedæµ**: åŸºäºæ¨æ¨¡å¼çš„å…³æ³¨ç”¨æˆ·åšå®¢æ¨é€

#### 5. åœ°ç†ä½ç½®æœåŠ¡
- **é™„è¿‘å•†é“º**: åŸºäºRedis GEOçš„åœ°ç†ä½ç½®æŸ¥è¯¢
- **è·ç¦»è®¡ç®—**: è‡ªåŠ¨è®¡ç®—ç”¨æˆ·ä¸å•†é“ºçš„è·ç¦»

## ğŸ“ é¡¹ç›®ç»“æ„

```
hmdp/
â”œâ”€â”€ src/main/java/com/hmdp/
â”‚   â”œâ”€â”€ HmDianPingApplication.java          # å¯åŠ¨ç±»
â”‚   â”œâ”€â”€ config/                             # é…ç½®ç±»
â”‚   â”‚   â”œâ”€â”€ MvcConfig.java                  # MVCé…ç½®
â”‚   â”‚   â”œâ”€â”€ MybatisConfig.java              # MyBatisé…ç½®
â”‚   â”‚   â”œâ”€â”€ RedissonConfig.java             # Redissoné…ç½®
â”‚   â”‚   â”œâ”€â”€ RabbitMQConfig.java             # RabbitMQé…ç½®
â”‚   â”‚   â”œâ”€â”€ UploadConfig.java               # æ–‡ä»¶ä¸Šä¼ é…ç½®
â”‚   â”‚   â””â”€â”€ WebExceptionAdvice.java         # å…¨å±€å¼‚å¸¸å¤„ç†
â”‚   â”œâ”€â”€ controller/                         # æ§åˆ¶å™¨å±‚
â”‚   â”‚   â”œâ”€â”€ BlogController.java             # åšå®¢æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ FollowController.java           # å…³æ³¨æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ ShopController.java             # å•†é“ºæ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ UserController.java             # ç”¨æˆ·æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ VoucherController.java          # ä¼˜æƒ åˆ¸æ§åˆ¶å™¨
â”‚   â”‚   â””â”€â”€ VoucherOrderController.java     # è®¢å•æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ dto/                                # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”‚   â”œâ”€â”€ LoginFormDTO.java               # ç™»å½•è¡¨å•
â”‚   â”‚   â”œâ”€â”€ Result.java                     # ç»Ÿä¸€è¿”å›ç»“æœ
â”‚   â”‚   â”œâ”€â”€ ScrollResult.java               # æ»šåŠ¨åˆ†é¡µç»“æœ
â”‚   â”‚   â””â”€â”€ UserDTO.java                    # ç”¨æˆ·ä¿¡æ¯
â”‚   â”œâ”€â”€ entity/                             # å®ä½“ç±»
â”‚   â”‚   â”œâ”€â”€ Blog.java                       # åšå®¢å®ä½“
â”‚   â”‚   â”œâ”€â”€ Follow.java                     # å…³æ³¨å…³ç³»
â”‚   â”‚   â”œâ”€â”€ Shop.java                       # å•†é“ºå®ä½“
â”‚   â”‚   â”œâ”€â”€ User.java                       # ç”¨æˆ·å®ä½“
â”‚   â”‚   â”œâ”€â”€ Voucher.java                    # ä¼˜æƒ åˆ¸å®ä½“
â”‚   â”‚   â””â”€â”€ VoucherOrder.java               # è®¢å•å®ä½“
â”‚   â”œâ”€â”€ interceptor/                        # æ‹¦æˆªå™¨
â”‚   â”‚   â”œâ”€â”€ LoginInterceptor.java           # ç™»å½•æ‹¦æˆªå™¨
â”‚   â”‚   â””â”€â”€ RefreshTokenInterceptor.java    # Tokenåˆ·æ–°æ‹¦æˆªå™¨
â”‚   â”œâ”€â”€ mapper/                             # æ•°æ®è®¿é—®å±‚
â”‚   â”‚   â”œâ”€â”€ BlogMapper.java                 # åšå®¢Mapper
â”‚   â”‚   â”œâ”€â”€ ShopMapper.java                 # å•†é“ºMapper
â”‚   â”‚   â”œâ”€â”€ UserMapper.java                 # ç”¨æˆ·Mapper
â”‚   â”‚   â””â”€â”€ VoucherOrderMapper.java         # è®¢å•Mapper
â”‚   â”œâ”€â”€ listener/                           # æ¶ˆæ¯ç›‘å¬å™¨
â”‚   â”‚   â””â”€â”€ SeckillOrderListener.java       # ç§’æ€è®¢å•æ¶ˆæ¯ç›‘å¬å™¨
â”‚   â”œâ”€â”€ service/                            # æœåŠ¡æ¥å£å±‚
â”‚   â”‚   â”œâ”€â”€ IBlogService.java               # åšå®¢æœåŠ¡æ¥å£
â”‚   â”‚   â”œâ”€â”€ IShopService.java               # å•†é“ºæœåŠ¡æ¥å£
â”‚   â”‚   â”œâ”€â”€ IUserService.java               # ç”¨æˆ·æœåŠ¡æ¥å£
â”‚   â”‚   â”œâ”€â”€ IVoucherOrderService.java       # è®¢å•æœåŠ¡æ¥å£
â”‚   â”‚   â”œâ”€â”€ MessageProducerService.java     # æ¶ˆæ¯ç”Ÿäº§è€…æœåŠ¡æ¥å£
â”‚   â”‚   â””â”€â”€ SeckillDataInitService.java     # ç§’æ€æ•°æ®åˆå§‹åŒ–æœåŠ¡æ¥å£
â”‚   â”œâ”€â”€ service/impl/                       # æœåŠ¡å®ç°å±‚
â”‚   â”‚   â”œâ”€â”€ BlogServiceImpl.java            # åšå®¢æœåŠ¡å®ç°
â”‚   â”‚   â”œâ”€â”€ ShopServiceImpl.java            # å•†é“ºæœåŠ¡å®ç°
â”‚   â”‚   â”œâ”€â”€ UserServiceImpl.java            # ç”¨æˆ·æœåŠ¡å®ç°
â”‚   â”‚   â”œâ”€â”€ VoucherOrderServiceImpl.java    # è®¢å•æœåŠ¡å®ç°
â”‚   â”‚   â”œâ”€â”€ MessageProducerServiceImpl.java # æ¶ˆæ¯ç”Ÿäº§è€…æœåŠ¡å®ç°
â”‚   â”‚   â””â”€â”€ SeckillDataInitServiceImpl.java # ç§’æ€æ•°æ®åˆå§‹åŒ–æœåŠ¡å®ç°
â”‚   â””â”€â”€ utils/                              # å·¥å…·ç±»
â”‚       â”œâ”€â”€ CacheClient.java                # ç¼“å­˜å·¥å…·ç±»
â”‚       â”œâ”€â”€ ILock.java                      # åˆ†å¸ƒå¼é”æ¥å£
â”‚       â”œâ”€â”€ SimpleRedisLock.java            # Redisåˆ†å¸ƒå¼é”å®ç°
â”‚       â”œâ”€â”€ RedisIdWorker.java              # Redis IDç”Ÿæˆå™¨
â”‚       â”œâ”€â”€ RedisConstants.java             # Rediså¸¸é‡
â”‚       â””â”€â”€ UserHolder.java                 # ç”¨æˆ·ä¸Šä¸‹æ–‡
â”œâ”€â”€ src/main/resources/
â”‚   â”œâ”€â”€ application.yaml                    # åº”ç”¨é…ç½®
â”‚   â”œâ”€â”€ mapper/                             # MyBatisæ˜ å°„æ–‡ä»¶
â”‚   â”œâ”€â”€ seckill.lua                         # ç§’æ€Luaè„šæœ¬ï¼ˆå·²ä¼˜åŒ–nilå€¼æ£€æŸ¥ï¼‰
â”‚   â””â”€â”€ unlock.lua                          # è§£é”Luaè„šæœ¬
â”œâ”€â”€ hmdp.sql                                # æ•°æ®åº“è„šæœ¬
â”œâ”€â”€ rabbitmq-setup.md                       # RabbitMQå®‰è£…æŒ‡å—
â””â”€â”€ pom.xml                                 # Mavené…ç½®
```

## ğŸš€ å¿«é€Ÿå¯åŠ¨

### ç¯å¢ƒè¦æ±‚
- JDK 11+
- Maven 3.6+
- MySQL 8.0+
- Redis 6.0+
- RabbitMQ 3.8+ (æ¨èä½¿ç”¨Docker)

### å¯åŠ¨æ­¥éª¤

1. **å…‹éš†é¡¹ç›®**
```bash
git clone <repository-url>
cd hmdp
```

2. **æ•°æ®åº“åˆå§‹åŒ–**
```bash
# åˆ›å»ºæ•°æ®åº“
mysql -u root -p
CREATE DATABASE hmdp;

# å¯¼å…¥æ•°æ®
mysql -u root -p hmdp < hmdp.sql
```

3. **é…ç½®æ–‡ä»¶**
ä¿®æ”¹ `src/main/resources/application.yaml`:
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/hmdp
    username: your_username
    password: your_password
  redis:
    host: localhost
    port: 6379
    password: your_redis_password  # å¦‚æœæœ‰å¯†ç 
  rabbitmq:
    host: localhost
    port: 5672
    username: guest
    password: guest
```

4. **å¯åŠ¨Redis**
```bash
redis-server
```

5. **å¯åŠ¨RabbitMQ**
```bash
# ä½¿ç”¨Dockerï¼ˆæ¨èï¼‰
docker run -d --name rabbitmq \
  -p 5672:5672 \
  -p 15672:15672 \
  -e RABBITMQ_DEFAULT_USER=guest \
  -e RABBITMQ_DEFAULT_PASS=guest \
  rabbitmq:3-management

# æˆ–è€…ç›´æ¥å¯åŠ¨ï¼ˆå¦‚æœå·²å®‰è£…ï¼‰
rabbitmq-server
```

6. **åˆå§‹åŒ–ç§’æ€æ•°æ®**
```bash
# å¯åŠ¨åº”ç”¨åï¼Œåˆå§‹åŒ–ç§’æ€åˆ¸åº“å­˜
curl -X POST http://localhost:8081/voucher-order/init/all
```

7. **è¿è¡Œé¡¹ç›®**
```bash
mvn spring-boot:run
```

8. **è®¿é—®åº”ç”¨**
- åç«¯API: http://localhost:8081
- RabbitMQç®¡ç†ç•Œé¢: http://localhost:15672 (guest/guest)
- æ¥å£æ–‡æ¡£: æŸ¥çœ‹å„Controllerç±»çš„æ¥å£å®šä¹‰

## ğŸ”§ æ ¸å¿ƒæŠ€æœ¯ç‰¹æ€§

### Redisåº”ç”¨åœºæ™¯

| åŠŸèƒ½ | Redisæ•°æ®ç»“æ„ | åº”ç”¨åœºæ™¯ |
|------|---------------|----------|
| ç”¨æˆ·ç™»å½• | Hash | å­˜å‚¨éªŒè¯ç å’Œç”¨æˆ·Tokenï¼Œæ”¯æŒç”¨æˆ·ä¿¡æ¯ç¼“å­˜ |
| ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ | Hash | ç¼“å­˜ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼Œæ”¯æŒå®æ—¶æ›´æ–°åŒæ­¥ |
| å•†é“ºç¼“å­˜ | String | ç¼“å­˜å•†é“ºä¿¡æ¯ï¼Œè§£å†³ç¼“å­˜ç©¿é€/å‡»ç©¿/é›ªå´© |
| ç‚¹èµæ’è¡Œ | ZSet | åšå®¢ç‚¹èµç”¨æˆ·æ’åº |
| å…³æ³¨åˆ—è¡¨ | Set | å­˜å‚¨ç”¨æˆ·å…³æ³¨å…³ç³»ï¼Œè®¡ç®—å…±åŒå…³æ³¨ |
| ç­¾åˆ°ç»Ÿè®¡ | BitMap | ç”¨æˆ·è¿ç»­ç­¾åˆ°å¤©æ•°ç»Ÿè®¡ |
| é™„è¿‘å•†é“º | GEO | åœ°ç†ä½ç½®æŸ¥è¯¢ |
| ç§’æ€åº“å­˜ | String + Lua | åŸå­æ€§åº“å­˜æ‰£å‡ï¼ˆå·²ä¼˜åŒ–nilå€¼æ£€æŸ¥ï¼‰ |
| åˆ†å¸ƒå¼é” | String + Lua | é˜²æ­¢å¹¶å‘é—®é¢˜ |
| Feedæµ | ZSet | å…³æ³¨ç”¨æˆ·åšå®¢æ—¶é—´çº¿ |
| æ¶ˆæ¯å»é‡ | String | é˜²æ­¢RabbitMQæ¶ˆæ¯é‡å¤å¤„ç† |

### RabbitMQæ¶ˆæ¯é˜Ÿåˆ—

| ç»„ä»¶ | è¯´æ˜ | ç‰¹æ€§ |
|------|------|------|
| **ç§’æ€è®¢å•é˜Ÿåˆ—** | `seckill.order.queue` | å¤„ç†ç§’æ€è®¢å•å¼‚æ­¥åˆ›å»º |
| **æ­»ä¿¡é˜Ÿåˆ—** | `seckill.order.dlx.queue` | å¤„ç†å¤±è´¥æ¶ˆæ¯ï¼Œæ”¯æŒäººå·¥ä»‹å…¥ |
| **æ¶ˆæ¯é‡è¯•** | è‡ªåŠ¨é‡è¯•æœºåˆ¶ | æœ€å¤šé‡è¯•3æ¬¡ï¼Œå¤±è´¥åè¿›å…¥æ­»ä¿¡é˜Ÿåˆ— |
| **æ¶ˆæ¯ç¡®è®¤** | æ‰‹åŠ¨ACK | ç¡®ä¿æ¶ˆæ¯å¤„ç†æˆåŠŸåæ‰ç¡®è®¤ |
| **å¹‚ç­‰å¤„ç†** | Rediså»é‡ | é˜²æ­¢æ¶ˆæ¯é‡å¤å¤„ç† |

### åˆ†å¸ƒå¼é”å®ç°
- åŸºäºRedisçš„SET NX EXå‘½ä»¤
- Luaè„šæœ¬ä¿è¯åŸå­æ€§
- è‡ªåŠ¨ç»­æœŸæœºåˆ¶ï¼ˆRedissonï¼‰
- é˜²æ­¢é”è¯¯åˆ é™¤

### ç¼“å­˜ç­–ç•¥
- **ç¼“å­˜ç©¿é€**: ç©ºå€¼ç¼“å­˜ + å¸ƒéš†è¿‡æ»¤å™¨
- **ç¼“å­˜å‡»ç©¿**: äº’æ–¥é” + é€»è¾‘è¿‡æœŸ
- **ç¼“å­˜é›ªå´©**: TTLéšæœºåŒ– + å¤šçº§ç¼“å­˜

### ç§’æ€ç³»ç»Ÿæ¶æ„

```
ç”¨æˆ·è¯·æ±‚ â†’ Luaè„šæœ¬(åº“å­˜æ£€æŸ¥) â†’ RabbitMQé˜Ÿåˆ— â†’ å¼‚æ­¥å¤„ç† â†’ æ•°æ®åº“
    â†“              â†“                â†“           â†“
  å‚æ•°æ ¡éªŒ      åŸå­æ€§æ“ä½œ        æ¶ˆæ¯æŒä¹…åŒ–    è®¢å•å…¥åº“
    â†“              â†“                â†“           â†“
  è¿”å›ç»“æœ      é˜²æ­¢è¶…å–          é‡è¯•æœºåˆ¶     å®Œæˆè®¢å•
```

**ç§’æ€æµç¨‹ä¼˜åŒ–**:
1. **é¢„æ£€æŸ¥**: Luaè„šæœ¬åŸå­æ€§æ£€æŸ¥åº“å­˜å’Œç”¨æˆ·èµ„æ ¼
2. **å¼‚æ­¥å¤„ç†**: RabbitMQè§£è€¦ï¼Œæå‡å“åº”é€Ÿåº¦
3. **å¯é æ€§ä¿è¯**: æ¶ˆæ¯æŒä¹…åŒ– + æ­»ä¿¡é˜Ÿåˆ— + é‡è¯•æœºåˆ¶
4. **å¹‚ç­‰æ€§**: Rediså»é‡ + åˆ†å¸ƒå¼é”é˜²æ­¢é‡å¤å¤„ç†

## ğŸ¯ APIæ¥å£è¯´æ˜

### ç”¨æˆ·ç®¡ç†æ¥å£

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/user/code` | POST | å‘é€æ‰‹æœºéªŒè¯ç  |
| `/user/login` | POST | æ‰‹æœºéªŒè¯ç ç™»å½• |
| `/user/logout` | POST | ç”¨æˆ·ç™»å‡º |
| `/user/me` | GET | è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ |
| `/user/update` | PUT | æ›´æ–°ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆæ˜µç§°ç­‰ï¼‰ |
| `/user/info/update` | PUT | æ›´æ–°ç”¨æˆ·è¯¦ç»†ä¿¡æ¯ï¼ˆåŸå¸‚ã€ä»‹ç»ç­‰ï¼‰ |
| `/user/avatar/upload` | POST | å¤´åƒä¸Šä¼ ï¼ˆæ–‡ä»¶ä¸Šä¼ +æ•°æ®åº“æ›´æ–°ï¼‰ |
| `/user/info/{id}` | GET | è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯ |
| `/user/sign` | POST | ç”¨æˆ·ç­¾åˆ° |
| `/user/sign/count` | GET | è·å–ç­¾åˆ°ç»Ÿè®¡ |

### ç§’æ€ç›¸å…³æ¥å£

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/voucher-order/seckill/{id}` | POST | ç§’æ€ä¼˜æƒ åˆ¸ |
| `/voucher-order/init/{voucherId}` | POST | åˆå§‹åŒ–å•ä¸ªç§’æ€åˆ¸åº“å­˜ |
| `/voucher-order/init/all` | POST | æ‰¹é‡åˆå§‹åŒ–æ‰€æœ‰ç§’æ€åˆ¸åº“å­˜ |
| `/voucher-order/clean/expired` | POST | æ¸…ç†è¿‡æœŸç§’æ€æ•°æ® |

### è°ƒè¯•æ¥å£

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/shop/debug/types` | GET | æŸ¥çœ‹å•†é“ºç±»å‹åˆ†å¸ƒ |
| `/shop/debug/geo/{typeId}` | GET | æ£€æŸ¥Redis GEOæ•°æ® |
| `/shop/init/geo` | POST | åˆå§‹åŒ–å•†é“ºåœ°ç†ä½ç½®æ•°æ® |
| `/upload/debug/config` | GET | æ£€æŸ¥æ–‡ä»¶ä¸Šä¼ é…ç½® |

## ğŸ“š å­¦ä¹ èµ„æº

æœ¬é¡¹ç›®æ¥è‡ªé»‘é©¬ç¨‹åºå‘˜Redisæ•™ç¨‹ï¼Œå¹¶è¿›è¡Œäº†æ·±åº¦ä¼˜åŒ–ï¼š
- è§†é¢‘æ•™ç¨‹: [Rediså…¥é—¨åˆ°å®æˆ˜](https://www.bilibili.com/video/BV1cr4y1671t)
- å®æˆ˜ç¯‡ä»P24å¼€å§‹

### é¡¹ç›®åˆ†æ”¯è¯´æ˜
- **master**: å®Œæ•´ç‰ˆä»£ç ï¼ŒåŒ…å«RabbitMQä¼˜åŒ–å’Œé”™è¯¯ä¿®å¤
- **init**: åˆå§‹åŒ–ä»£ç ï¼Œé€‚åˆè·Ÿç€æ•™ç¨‹å­¦ä¹ å¼€å‘

## ğŸŒŸ æŠ€æœ¯äº®ç‚¹

### 1. é«˜å¹¶å‘ç§’æ€ç³»ç»Ÿ
- **QPSä¼˜åŒ–**: é€šè¿‡Redisé¢„æ£€æŸ¥ + å¼‚æ­¥å¤„ç†ï¼Œæ”¯æŒä¸‡çº§QPS
- **è¶…å–é˜²æŠ¤**: Luaè„šæœ¬åŸå­æ€§æ“ä½œ + åˆ†å¸ƒå¼é”åŒé‡ä¿éšœ
- **ç”¨æˆ·ä½“éªŒ**: å¿«é€Ÿå“åº”ï¼Œå¼‚æ­¥å¤„ç†è®¢å•åˆ›å»º

### 2. æ¶ˆæ¯é˜Ÿåˆ—å¯é æ€§
- **æ¶ˆæ¯æŒä¹…åŒ–**: RabbitMQç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±
- **é‡è¯•æœºåˆ¶**: è‡ªåŠ¨é‡è¯•3æ¬¡ï¼Œå¤±è´¥è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—
- **ç›‘æ§å‘Šè­¦**: é€šè¿‡ç®¡ç†ç•Œé¢å®æ—¶ç›‘æ§é˜Ÿåˆ—çŠ¶æ€

### 3. ç¼“å­˜æ¶æ„ä¼˜åŒ–
- **å¤šçº§ç¼“å­˜**: æœ¬åœ°ç¼“å­˜ + Redisç¼“å­˜
- **ç¼“å­˜ä¸€è‡´æ€§**: æ›´æ–°ç­–ç•¥ + è¿‡æœŸæ—¶é—´æ§åˆ¶
- **æ€§èƒ½ç›‘æ§**: è¯¦ç»†çš„ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡

### 4. ç”¨æˆ·ä½“éªŒä¼˜åŒ– âœ¨
- **å¤´åƒä¸Šä¼ **: ä¸€é”®ä¸Šä¼ ï¼Œè‡ªåŠ¨æ›´æ–°æ•°æ®åº“å’Œç¼“å­˜ï¼Œå‰ç«¯å®æ—¶æ˜¾ç¤º
- **ä¿¡æ¯åŒæ­¥**: ç”¨æˆ·ä¿¡æ¯æ›´æ–°åç«‹å³åŒæ­¥åˆ°Redisç¼“å­˜å’Œå‰ç«¯æ˜¾ç¤º
- **ä¼šè¯ç®¡ç†**: å®Œå–„çš„ç™»å½•çŠ¶æ€ç®¡ç†ï¼ŒTokenè‡ªåŠ¨ç»­æœŸ
- **é”™è¯¯å¤„ç†**: å‹å¥½çš„é”™è¯¯æç¤ºå’Œå¼‚å¸¸å¤„ç†æœºåˆ¶

### 5. ç³»ç»Ÿç¨³å®šæ€§
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œé™çº§ç­–ç•¥
- **æ—¥å¿—ç›‘æ§**: è¯¦ç»†çš„ä¸šåŠ¡æ—¥å¿—å’Œæ€§èƒ½æŒ‡æ ‡
- **æ•°æ®ç®¡ç†**: è‡ªåŠ¨åŒ–çš„æ•°æ®åˆå§‹åŒ–å’Œæ¸…ç†
- **ç¼“å­˜ä¸€è‡´æ€§**: æ•°æ®åº“æ›´æ–°ä¸Redisç¼“å­˜å®æ—¶åŒæ­¥

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| ç§’æ€QPS | 10,000+ | Redis + RabbitMQå¼‚æ­¥å¤„ç† |
| å“åº”æ—¶é—´ | <100ms | Luaè„šæœ¬å¿«é€Ÿé¢„æ£€æŸ¥ |
| æ¶ˆæ¯å¤„ç† | 99.9%+ | RabbitMQå¯é æ€§ä¿è¯ |
| ç¼“å­˜å‘½ä¸­ç‡ | 95%+ | å¤šçº§ç¼“å­˜ç­–ç•¥ |

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒåŸæ•™ç¨‹æˆ–æäº¤Issueã€‚

## ğŸ† è‡´è°¢

æ„Ÿè°¢é»‘é©¬ç¨‹åºå‘˜æä¾›çš„ä¼˜ç§€æ•™ç¨‹ï¼Œæœ¬é¡¹ç›®åœ¨åŸæœ‰åŸºç¡€ä¸Šè¿›è¡Œäº†æ·±åº¦ä¼˜åŒ–å’Œæ‰©å±•ã€‚

## 1.ä¸‹è½½
å…‹éš†å®Œæ•´é¡¹ç›®
```git
git clone https://github.com/sgahch/hmdp.git
```
åˆ‡æ¢åˆ†æ”¯
```git
git checkout init
```

## 2.å¸¸è§é—®é¢˜

### Q1: RabbitMQè¿æ¥å¤±è´¥
**é”™è¯¯**: `Connection refused` æˆ– `AMQP connection error`

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥RabbitMQæ˜¯å¦å¯åŠ¨
docker ps | grep rabbitmq

# å¦‚æœæœªå¯åŠ¨ï¼Œæ‰§è¡Œå¯åŠ¨å‘½ä»¤
docker run -d --name rabbitmq \
  -p 5672:5672 \
  -p 15672:15672 \
  rabbitmq:3-management
```

### Q2: ç§’æ€æ—¶æç¤º"ç§’æ€æ´»åŠ¨æœªå¼€å§‹æˆ–å·²ç»“æŸ"
**é”™è¯¯ç **: è¿”å›é”™è¯¯ç 3

**è§£å†³æ–¹æ¡ˆ**:
```bash
# åˆå§‹åŒ–ç§’æ€åˆ¸åº“å­˜
curl -X POST http://localhost:8081/voucher-order/init/all

# æˆ–åˆå§‹åŒ–å•ä¸ªç§’æ€åˆ¸
curl -X POST http://localhost:8081/voucher-order/init/{voucherId}
```

### Q3: Redis Luaè„šæœ¬é”™è¯¯
**é”™è¯¯**: `attempt to compare nil with number`

**è§£å†³æ–¹æ¡ˆ**: å·²åœ¨æœ€æ–°ç‰ˆæœ¬ä¸­ä¿®å¤ï¼Œç¡®ä¿ä½¿ç”¨æœ€æ–°çš„seckill.luaè„šæœ¬

### Q4: å›¾ç‰‡ä¸Šä¼ å¤±è´¥
**é”™è¯¯**: ä¸Šä¼ ç›®å½•ä¸å­˜åœ¨

**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥nginxç›®å½•é…ç½®ï¼Œç¡®ä¿è·¯å¾„æ­£ç¡®
```bash
# æ£€æŸ¥ä¸Šä¼ é…ç½®
curl http://localhost:8081/upload/debug/config
```

### Q5: åœ°ç†ä½ç½®æŸ¥è¯¢æ— ç»“æœ
**è§£å†³æ–¹æ¡ˆ**: åˆå§‹åŒ–å•†é“ºåœ°ç†ä½ç½®æ•°æ®
```bash
curl -X POST http://localhost:8081/shop/init/geo
```

### Q6: ç”¨æˆ·ç™»å½•åä¿¡æ¯æ›´æ–°ä¸æ˜¾ç¤º
**é”™è¯¯**: æ›´æ–°æ˜µç§°æˆ–å¤´åƒåå‰ç«¯ä¸æ˜¾ç¤ºæœ€æ–°ä¿¡æ¯

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥Redisç¼“å­˜æ˜¯å¦æ­£å¸¸å·¥ä½œ
2. ç¡®ä¿ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ä»£ç ï¼ˆå·²ä¿®å¤ç¼“å­˜åŒæ­¥é—®é¢˜ï¼‰
3. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å¹¶é‡æ–°ç™»å½•

### Q7: å¤´åƒä¸Šä¼ å¤±è´¥
**é”™è¯¯**: "å¤´åƒä¸Šä¼ å¤±è´¥"æˆ–æ–‡ä»¶ä¸Šä¼ é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ä¸Šä¼ ç›®å½•æƒé™
ls -la nginx-1.18.0/html/hmdp/imgs/

# ç¡®ä¿ç›®å½•å­˜åœ¨ä¸”å¯å†™
mkdir -p nginx-1.18.0/html/hmdp/imgs/
chmod 755 nginx-1.18.0/html/hmdp/imgs/
```

### Q8: ç™»å½•æ—¶å‡ºç°NullPointerException
**é”™è¯¯**: ç™»å½•è¿‡ç¨‹ä¸­ç©ºæŒ‡é’ˆå¼‚å¸¸

**è§£å†³æ–¹æ¡ˆ**: å·²åœ¨æœ€æ–°ç‰ˆæœ¬ä¸­ä¿®å¤ï¼Œç¡®ä¿UserDTOä¸­çš„å­—æ®µæ­£ç¡®å¤„ç†nullå€¼
